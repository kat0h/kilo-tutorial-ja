
<!doctype html>
<html lang="ja" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.3.3">
    
    
      
        <title>A text editor - Kilo tutorial</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.5143246d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#a-text-editor" class="md-skip">
          コンテンツにスキップ
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="ヘッダー">
    <a href="../.." title="Kilo tutorial" class="md-header__button md-logo" aria-label="Kilo tutorial" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kilo tutorial
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              A text editor
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="検索" placeholder="検索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="クリア" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            検索を初期化
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="ナビゲーション" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Kilo tutorial" class="md-nav__button md-logo" aria-label="Kilo tutorial" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Kilo tutorial
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        自分自身のテキストエディターを作ろう
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Contents
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Contents" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Contents
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../01setup/" class="md-nav__link">
        セットアップ
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../02enteringRawMode/" class="md-nav__link">
        Rawモードに入る
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../03rawInputAndOutput/" class="md-nav__link">
        Raw input and output
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../04aTextViewer/" class="md-nav__link">
        A text viewer
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          A text editor
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        A text editor
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="目次">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目次
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#insert-ordinary-characters" class="md-nav__link">
    Insert ordinary characters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prevent-inserting-special-characters" class="md-nav__link">
    Prevent inserting special characters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#save-to-disk" class="md-nav__link">
    Save to disk
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dirty-flag" class="md-nav__link">
    Dirty flag
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quit-confirmation" class="md-nav__link">
    Quit confirmation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simple-backspacing" class="md-nav__link">
    Simple backspacing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backspacing-at-the-start-of-a-line" class="md-nav__link">
    Backspacing at the start of a line
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-enter-key" class="md-nav__link">
    The Enter key
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#save-as" class="md-nav__link">
    Save as...
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../06search/" class="md-nav__link">
        Search
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../07syntaxHighlighting/" class="md-nav__link">
        Syntax highlighting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../08appendices/" class="md-nav__link">
        Appendices
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="目次">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目次
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#insert-ordinary-characters" class="md-nav__link">
    Insert ordinary characters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prevent-inserting-special-characters" class="md-nav__link">
    Prevent inserting special characters
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#save-to-disk" class="md-nav__link">
    Save to disk
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dirty-flag" class="md-nav__link">
    Dirty flag
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quit-confirmation" class="md-nav__link">
    Quit confirmation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simple-backspacing" class="md-nav__link">
    Simple backspacing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#backspacing-at-the-start-of-a-line" class="md-nav__link">
    Backspacing at the start of a line
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-enter-key" class="md-nav__link">
    The Enter key
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#save-as" class="md-nav__link">
    Save as...
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="a-text-editor">A text editor</h1>
<h2 id="insert-ordinary-characters">Insert ordinary characters</h2>
<p>Let's begin by writing a function that inserts a single character into an
<code>erow</code>, at a given position.</p>
<p>{{row-insert-char}}</p>
<p><code>memmove()</code> comes from <code>&lt;string.h&gt;</code>. It is like <code>memcpy()</code>, but is safe to use
when the source and destination arrays overlap.</p>
<p>First we validate <code>at</code>, which is the index we want to insert the character
into. Notice that <code>at</code> is allowed to go one character past the end of the
string, in which case the character should be inserted at the end of the
string.</p>
<p>Then we allocate one more byte for the <code>chars</code> of the <code>erow</code> (we add <code>2</code>
because we also have to make room for the null byte), and use <code>memmove()</code> to
make room for the new character. We increment the <code>size</code> of the <code>chars</code> array,
and then actually assign the character to its position in the array. Finally,
we call <code>editorUpdateRow()</code> so that the <code>render</code> and <code>rsize</code> fields get updated
with the new row content.</p>
<p>Now we'll create a new section called <code>/*** editor operations ***/</code>. This
section will contain functions that we'll call from <code>editorProcessKeypress()</code>
when we're mapping keypresses to various text editing operations. We'll add a
function to this section called <code>editorInsertChar()</code> which will take a
character and use <code>editorRowInsertChar()</code> to insert that character into the
position that the cursor is at.</p>
<p>{{editor-insert-char}}</p>
<p>If <code>E.cy == E.numrows</code>, then the cursor is on the tilde line after the end of
the file, so we need to append a new row to the file before inserting a
character there. After inserting a character, we move the cursor forward so
that the next character the user inserts will go after the character just
inserted.</p>
<p>Notice that <code>editorInsertChar()</code> doesn't have to worry about the details of
modifying an <code>erow</code>, and <code>editorRowInsertChar()</code> doesn't have to worry about
where the cursor is. That is the difference between functions in the
<code>/*** editor operations ***/</code> section and functions in the
<code>/*** row operations ***/</code> section.</p>
<p>Let's call <code>editorInsertChar()</code> in the <code>default:</code> case of the <code>switch</code>
statement in <code>editorProcessKeypress()</code>. This will allow any keypress that isn't
mapped to another editor function to be inserted directly into the text being
edited.</p>
<p>{{key-insert-char}}</p>
<p>We've now officially upgraded our text viewer to a text editor.</p>
<h2 id="prevent-inserting-special-characters">Prevent inserting special characters</h2>
<p>Currently, if you press keys like <kbd>Backspace</kbd> or <kbd>Enter</kbd>,
those characters will be inserted directly into the text, which we certainly
don't want. Let's handle a bunch of these special keys in
<code>editorProcessKeypress()</code>, so that they don't fall through to the <code>default</code>
case of calling <code>editorInsertChar()</code>.</p>
<p>{{block-special-chars}}</p>
<p><kbd>Backspace</kbd> doesn't have a human-readable backslash-escape
representation in C (like <code>\n</code>, <code>\r</code>, and so on), so we make it part of the
<code>editorKey</code> enum and assign it its ASCII value of <code>127</code>.</p>
<p>In <code>editorProcessKeypress()</code>, the first new key we add to the <code>switch</code>
statement is <code>'\r'</code>, which is the <kbd>Enter</kbd> key. For now we want to
ignore it, but obviously we'll be making it do something later, so we mark it
with a <code>TODO</code> comment.</p>
<p>We handle <kbd>Backspace</kbd> and <kbd>Delete</kbd> in a similar way, marking
them with a <code>TODO</code>. We also handle the <kbd>Ctrl-H</kbd> key combination, which
sends the control code <code>8</code>, which is originally what the <kbd>Backspace</kbd>
character would send back in the day. If you look at the
<a href="http://www.asciitable.com/">ASCII table</a>, you'll see that ASCII code <code>8</code> is
named <code>BS</code> for "backspace", and ASCII code <code>127</code> is named <code>DEL</code> for "delete".
But for whatever reason, in modern computers the <kbd>Backspace</kbd> key is
mapped to <code>127</code> and the <kbd>Delete</kbd> key is mapped to the escape sequence
<code>&lt;esc&gt;[3~</code>, as we saw at the end of
<a href="03.rawInputAndOutput.html#the-delete-key">chapter 3</a>.</p>
<p>Lastly, we handle <kbd>Ctrl-L</kbd> and <kbd>Escape</kbd> by not doing anything
when those keys are pressed. <kbd>Ctrl-L</kbd> is traditionally used to refresh
the screen in terminal programs. In our text editor, the screen refreshes after
<em>any</em> keypress, so we don't have to do anything else to implement that feature.
We ignore the <kbd>Escape</kbd> key because there are many key escape sequences
that we aren't handling (such as the <kbd>F1</kbd>&ndash;<kbd>F12</kbd> keys),
and the way we wrote <code>editorReadKey()</code>, pressing those keys will be equivalent
to pressing the <kbd>Escape</kbd> key. We don't want the user to unwittingly
insert the escape character <code>27</code> into their text, so we ignore those
keypresses.</p>
<h2 id="save-to-disk">Save to disk</h2>
<p>Now that we've finally made text editable, let's implement saving to disk.
First we'll write a function that converts our array of <code>erow</code> structs into a
single string that is ready to be written out to a file.</p>
<p>{{rows-to-string}}</p>
<p>First we add up the lengths of each row of text, adding <code>1</code> to each one for the
newline character we'll add to the end of each line. We save the total length
into <code>buflen</code>, to tell the caller how long the string is.</p>
<p>Then, after allocating the required memory, we loop through the rows, and
<code>memcpy()</code> the contents of each row to the end of the buffer, appending a
newline character after each row.</p>
<p>We return <code>buf</code>, expecting the caller to <code>free()</code> the memory.</p>
<p>Now we'll implement the <code>editorSave()</code> function, which will actually write the
string returned by <code>editorRowsToString()</code> to disk.</p>
<p>{{save}}</p>
<p><code>open()</code>, <code>O_RDWR</code>, and <code>O_CREAT</code> come from <code>&lt;fcntl.h&gt;</code>. <code>ftruncate()</code> and
<code>close()</code> come from <code>&lt;unistd.h&gt;</code>.</p>
<p>If it's a new file, then <code>E.filename</code> will be <code>NULL</code>, and we won't know where
to save the file, so we just <code>return</code> without doing anything for now. Later,
we'll figure out how to prompt the user for a filename.</p>
<p>Otherwise, we call <code>editorRowsToString()</code>, and <code>write()</code> the string to the path
in <code>E.filename</code>. We tell <code>open()</code> we want to create a new file if it
doesn't already exist (<code>O_CREAT</code>), and we want to open it for reading and
writing (<code>O_RDWR</code>). Because we used the <code>O_CREAT</code> flag, we have to pass an
extra argument containing the mode (the permissions) the new file should have.
<code>0644</code> is the standard permissions you usually want for text files. It gives
the owner of the file permission to read and write the file, and everyone else
only gets permission to read the file.</p>
<p><code>ftruncate()</code> sets the file's size to the specified length. If the file is
larger than that, it will cut off any data at the end of the file to make it
that length. If the file is shorter, it will add <code>0</code> bytes at the end to make
it that length.</p>
<p>The normal way to overwrite a file is to pass the <code>O_TRUNC</code> flag to <code>open()</code>,
which truncates the file completely, making it an empty file, before writing
the new data into it. By truncating the file ourselves to the same length as
the data we are planning to write into it, we are making the whole overwriting
operation a little bit safer in case the <code>ftruncate()</code> call succeeds but the
<code>write()</code> call fails. In that case, the file would still contain most of the
data it had before. But if the file was truncated completely by the <code>open()</code>
call and then the <code>write()</code> failed, you'd end up with all of your data lost.</p>
<p>More advanced editors will write to a new, temporary file, and then rename that
file to the actual file the user wants to overwrite, and they'll carefully
check for errors through the whole process.</p>
<p>Anyways, all we have to do now is map a key to <code>editorSave()</code>, so let's do it!
We'll use <kbd>Ctrl-S</kbd>.</p>
<p>{{ctrl-s}}</p>
<p>You should be able to open a file in the editor, insert some characters, press
<kbd>Ctrl-S</kbd>, and reopen the file to confirm that the changes you made
were saved.</p>
<p>Let's add error handling to <code>editorSave()</code>.</p>
<p>{{save-errors}}</p>
<p><code>open()</code> and <code>ftruncate()</code> both return <code>-1</code> on error. We expect <code>write()</code> to
return the number of bytes we told it to write. Whether or not an error
occurred, we ensure that the file is closed and the memory that <code>buf</code> points to
is freed.</p>
<p>Let's use <code>editorSetStatusMessage()</code> to notify the user whether the save
succeeded or not. While we're at it, we'll add the <kbd>Ctrl-S</kbd> key
binding to the help message that's set in <code>main()</code>.</p>
<p>{{save-status-message}}</p>
<p><code>strerror()</code> comes from <code>&lt;string.h&gt;</code>.</p>
<p><code>strerror()</code> is like <code>perror()</code> (which we use in <code>die()</code>), but it takes the
<code>errno</code> value as an argument and returns the human-readable string for that
error code, so that we can make the error a part of the status message we
display to the user.</p>
<p>The above code doesn't actually compile, because we are trying to call
<code>editorSetStatusMessage()</code> before it is defined in the file. You can't do that
in C, because C was made to be a language that can be compiled in a <a href="https://en.wikipedia.org/wiki/One-pass_compiler">single
pass</a>, meaning it should be
possible to compile each part of a program without knowing what comes later in
the program.</p>
<p>When we call a function in C, the compiler needs to know the arguments and
return value of that function. We can tell the compiler this information about
<code>editorSetStatusMessage()</code> by declaring a function prototype for it near the
top of the file. This allows us to call the function before it is defined.
We'll add a new <code>/*** prototypes ***/</code> section and put the declaration under
it.</p>
<p>{{prototypes}}</p>
<h2 id="dirty-flag">Dirty flag</h2>
<p>We'd like to keep track of whether the text loaded in our editor differs from
what's in the file. Then we can warn the user that they might lose unsaved
changes when they try to quit.</p>
<p>We call a text buffer "dirty" if it has been modified since opening or saving
the file. Let's add a <code>dirty</code> variable to the global editor state, and
initialize it to <code>0</code>.</p>
<p>{{dirty}}</p>
<p>Let's show the state of <code>E.dirty</code> in the status bar, by displaying <code>(modified)</code>
after the filename if the file has been modified.</p>
<p>{{show-dirty}}</p>
<p>Now let's increment <code>E.dirty</code> in each row operation that makes a change to the
text.</p>
<p>{{increment-dirty}}</p>
<p>We could have used <code>E.dirty = 1</code> instead of <code>E.dirty++</code>, but by incrementing it
we can have a sense of "how dirty" the file is, which could be useful. (We'll
just be treating <code>E.dirty</code> as a boolean value in this tutorial, so it doesn't
really matter.)</p>
<p>If you open a file at this point, you'll see that <code>(modified)</code> appears right
away, before you make any changes. That's because <code>editorOpen()</code> calls
<code>editorAppendRow()</code>, which increments <code>E.dirty</code>. To fix that, let's reset
<code>E.dirty</code> to <code>0</code> at the end of <code>editorOpen()</code>, and also in <code>editorSave()</code>.</p>
<p>{{reset-dirty}}</p>
<p>Now you should see <code>(modified)</code> appear in the status bar when you first insert
a character, and you should see it disappear when you save the file to disk.</p>
<h2 id="quit-confirmation">Quit confirmation</h2>
<p>Now we're ready to warn the user about unsaved changes when they try to quit.
If <code>E.dirty</code> is set, we will display a warning in the status bar, and require
the user to press <kbd>Ctrl-Q</kbd> three more times in order to quit without
saving.</p>
<p>{{quit-confirmation}}</p>
<p>We use a static variable in <code>editorProcessKeypress()</code> to keep track of how many
more times the user must press <kbd>Ctrl-Q</kbd> to quit. Each time they press
<kbd>Ctrl-Q</kbd> with unsaved changes, we set the status message and decrement
<code>quit_times</code>. When <code>quit_times</code> gets to <code>0</code>, we finally allow the program to
exit. When they press any key other than <kbd>Ctrl-Q</kbd>, then <code>quit_times</code>
gets reset back to <code>3</code> at the end of the <code>editorProcessKeypress()</code> function.</p>
<h2 id="simple-backspacing">Simple backspacing</h2>
<p>Let's implement backspacing next. First we'll create an <code>editorRowDelChar()</code>
function, which deletes a character in an <code>erow</code>.</p>
<p>{{row-del-char}}</p>
<p>As you can see, it's very similar to <code>editorRowInsertChar()</code>, except we don't
have any memory management to do. We just use <code>memmove()</code> to overwrite the
deleted character with the characters that come after it (notice that the null
byte at the end gets included in the move). Then we decrement the row's <code>size</code>,
call <code>editorUpdateRow()</code>, and increment <code>E.dirty</code>.</p>
<p>Now let's implement <code>editorDelChar()</code>, which uses <code>editorRowDelChar()</code> to
delete the character that is to the left of the cursor.</p>
<p>{{editor-del-char}}</p>
<p>If the cursor's past the end of the file, then there is nothing to delete, and
we <code>return</code> immediately. Otherwise, we get the <code>erow</code> the cursor is on, and if
there is a character to the left of the cursor, we delete it and move the
cursor one to the left.</p>
<p>Let's map the <kbd>Backspace</kbd>, <kbd>Ctrl-H</kbd>, and <kbd>Delete</kbd>
keys to <code>editorDelChar()</code>.</p>
<p>{{key-del-char}}</p>
<p>It so happens that in our editor, pressing the <kbd>&rarr;</kbd> key and then
<kbd>Backspace</kbd> is equivalent to what you would expect from pressing the
<kbd>Delete</kbd> key in a text editor: it deletes the character to the right
of the cursor. So that is how we implement the <kbd>Delete</kbd> key above.</p>
<h2 id="backspacing-at-the-start-of-a-line">Backspacing at the start of a line</h2>
<p>Currently, <code>editorDelChar()</code> doesn't do anything when the cursor is at the
beginning of a line. When the user backspaces at the beginning of a line, we
want to append the contents of that line to the previous line, and then delete
the current line. This effectively backspaces the implicit <code>\n</code> character in
between the two lines to join them into one line.</p>
<p>So we need two new row operations: one for appending a string to a row, and one
for deleting a row. Let's start by implementing <code>editorDelRow()</code>, which will
also require an <code>editorFreeRow()</code> function for freeing the memory owned by the
<code>erow</code> we are deleting.</p>
<p>{{del-row}}</p>
<p><code>editorDelRow()</code> looks a lot like <code>editorRowDelChar()</code>, because in both cases
we are deleting a single element from an array of elements by its index.</p>
<p>First we validate the <code>at</code> index. Then we free the memory owned by the row
using <code>editorFreeRow()</code>. We then use <code>memmove()</code> to overwrite the deleted row
struct with the rest of the rows that come after it, and decrement <code>numrows</code>.
Finally, we increment <code>E.dirty</code>.</p>
<p>Now let's implement <code>editorRowAppendString()</code>, which appends a string to the
end of a row.</p>
<p>{{row-append-string}}</p>
<p>The row's new size is <code>row-&gt;size + len + 1</code> (including the null byte), so first
we allocate that much memory for <code>row-&gt;chars</code>. Then we simply <code>memcpy()</code> the
given string to the end of the contents of <code>row-&gt;chars</code>. We update <code>row-&gt;size</code>,
call <code>editorUpdateRow()</code> as usual, and increment <code>E.dirty</code> as usual.</p>
<p>Now we're ready to get <code>editorDelChar()</code> to handle the case where the cursor is
at the beginning of a line.</p>
<p>{{del-char-row}}</p>
<p>If the cursor is at the beginning of the <em>first</em> line, then there's nothing to
do, so we <code>return</code> immediately. Otherwise, if we find that <code>E.cx == 0</code>, we call
<code>editorRowAppendString()</code> and then <code>editorDelRow()</code> as we planned. <code>row</code> points
to the row we are deleting, so we append <code>row-&gt;chars</code> to the previous row, and
then delete the row that <code>E.cy</code> is on. We set <code>E.cx</code> to the end of the contents
of the previous row before appending to that row. That way, the cursor will end
up at the point where the two lines joined.</p>
<p>Notice that pressing the <kbd>Delete</kbd> key at the end of a line works as
the user would expect, joining the current line with the next line. This is
because moving the cursor to the right at the end of a line moves it to the
beginning of the next line. So making the <kbd>Delete</kbd> key an alias for
the <kbd>&rarr;</kbd> key followed by the <kbd>Backspace</kbd> key still works.</p>
<h2 id="the-enter-key">The <kbd>Enter</kbd> key</h2>
<p>The last editor operation we have to implement is the <kbd>Enter</kbd> key. The
<kbd>Enter</kbd> key allows the user to insert new lines into the text, or
split a line into two lines. The first thing we need to do is rename the
<code>editorAppendRow(...)</code> function to <code>editorInsertRow(int at, ...)</code>. It will now
be able to insert a row at the index specified by the new <code>at</code> argument.</p>
<p>{{append-to-insert}}</p>
<p>Much like <code>editorRowInsertChar()</code>, we first validate <code>at</code>, then allocate memory
for one more <code>erow</code>, and use <code>memmove()</code> to make room at the specified index
for the new row.</p>
<p>We also delete the old <code>int at = ...</code> line, since <code>at</code> is now being passed in
as an argument.</p>
<p>We now have to replace all calls to <code>editorAppendRow(...)</code> with calls to
<code>editorInsertRow(E.numrows, ...)</code>.</p>
<p>{{use-insert-row}}</p>
<p>Now that we have <code>editorInsertRow()</code>, we're ready to implement
<code>editorInsertNewline()</code>, which handles an <kbd>Enter</kbd> keypress.</p>
<p>{{insert-newline}}</p>
<p>If we're at the beginning of a line, all we have to do is insert a new blank
row before the line we're on.</p>
<p>Otherwise, we have to split the line we're on into two rows. First we call
<code>editorInsertRow()</code> and pass it the characters on the current row that are to
the right of the cursor. That creates a new row after the current one, with the
correct contents. Then we reassign the <code>row</code> pointer, because
<code>editorInsertRow()</code> calls <code>realloc()</code>, which might move memory around on us and
invalidate the pointer (yikes). Then we truncate the current row's contents by
setting its size to the position of the cursor, and we call
<code>editorUpdateRow()</code> on the truncated row. (<code>editorInsertRow()</code> already calls
<code>editorUpdateRow()</code> for the new row.)</p>
<p>In both cases, we increment <code>E.cy</code>, and set <code>E.cx</code> to <code>0</code> to move the cursor to
the beginning of the row.</p>
<p>Finally, let's actually map the <kbd>Enter</kbd> key to the
<code>editorInsertNewline()</code> operation.</p>
<p>{{enter-key}}</p>
<p>That concludes all of the text editing operations we are going to implement. If
you wish, and if you are brave enough, you may now start using the editor to
modify its own code for the rest of the tutorial. If you do, I suggest making
regular backups of your work (using <code>git</code> or similar) in case you run into bugs
in the editor.</p>
<h2 id="save-as">Save as...</h2>
<p>Currently, when the user runs <code>./kilo</code> with no arguments, they get a blank file
to edit but have no way of saving. We need a way of prompting the user to input
a filename when saving a new file. Let's make an <code>editorPrompt()</code> function that
displays a prompt in the status bar, and lets the user input a line of text
after the prompt.</p>
<p>{{prompt}}</p>
<p>The user's input is stored in <code>buf</code>, which is a dynamically allocated string
that we initalize to the empty string. We then enter an infinite loop that
repeatedly sets the status message, refreshes the screen, and waits for a
keypress to handle. The <code>prompt</code> is expected to be a format string containing a
<code>%s</code>, which is where the user's input will be displayed.</p>
<p>When the user presses <kbd>Enter</kbd>, and their input is not empty, the
status message is cleared and their input is returned. Otherwise, when they
input a printable character, we append it to <code>buf</code>. If <code>buflen</code> has reached the
maximum capacity we allocated (stored in <code>bufsize</code>), then we double <code>bufsize</code>
and allocate that amount of memory before appending to <code>buf</code>. We also make sure
that <code>buf</code> ends with a <code>\0</code> character, because both <code>editorSetStatusMessage()</code>
and the caller of <code>editorPrompt()</code> will use it to know where the string ends.</p>
<p>Notice that we have to make sure the input key isn't one of the special keys in
the <code>editorKey</code> enum, which have high integer values. To do that, we test
whether the input key is in the range of a <code>char</code> by making sure it is less
than <code>128</code>.</p>
<p>Now let's prompt the user for a filename in <code>editorSave()</code>, when <code>E.filename</code>
is <code>NULL</code>.</p>
<p>{{save-as}}</p>
<p>Great, we now have basic "Save as..." functionality. Next, let's allow the user 
to press <kbd>Escape</kbd> to cancel the input prompt.</p>
<p>{{prompt-escape}}</p>
<p>When an input prompt is cancelled, we <code>free()</code> the <code>buf</code> ourselves and return
<code>NULL</code>. So let's handle a return value of <code>NULL</code> in <code>editorSave()</code> by aborting
the save operation and displaying a "Save aborted" message to the user.</p>
<p>{{abort-save}}</p>
<p>(Note: If you're using <strong>Bash on Windows</strong>, you will have to press
<kbd>Escape</kbd> 3 times to get one <kbd>Escape</kbd> keypress to register in
our program, because the <code>read()</code> calls in <code>editorReadKey()</code> that look for an
escape sequence never time out.)</p>
<p>Now let's allow the user to press <kbd>Backspace</kbd> (or <kbd>Ctrl-H</kbd>,
or <kbd>Delete</kbd>) in the input prompt.</p>
<p>{{prompt-backspace}}</p>
<p>In the <a href="06.search.html">next chapter</a>, we'll make use of <code>editorPrompt()</code> to
implement an incremental search feature in our editor.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="フッター">
      
        
        <a href="../04aTextViewer/" class="md-footer__link md-footer__link--prev" aria-label="前: A text viewer" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                前
              </span>
              A text viewer
            </div>
          </div>
        </a>
      
      
        
        <a href="../06search/" class="md-footer__link md-footer__link--next" aria-label="次: Search" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                次
              </span>
              Search
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "\u30af\u30ea\u30c3\u30d7\u30dc\u30fc\u30c9\u3078\u30b3\u30d4\u30fc", "clipboard.copied": "\u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\u3000\u3001\u3002\uff0c\uff0e]+", "search.placeholder": "\u691c\u7d22", "search.result.placeholder": "\u691c\u7d22\u30ad\u30fc\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044", "search.result.none": "\u4f55\u3082\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f", "search.result.one": "1\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.other": "#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.more.one": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3082\u30461\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.more.other": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3042\u3068#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.term.missing": "\u691c\u7d22\u306b\u542b\u307e\u308c\u306a\u3044", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.8397ff9e.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f89c2efe.min.js"></script>
      
    
  </body>
</html>